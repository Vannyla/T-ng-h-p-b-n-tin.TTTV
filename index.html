<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ Mô phỏng Lệnh Điều kiện</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chosen Palette: Deep Sea Gradient (#203959, #416772) -->
    <!-- Application Structure Plan: Maintain the V6 UI and logic. The only change is the addition of a static "Definition & Purpose" block at the top of the left-hand column for each order type, as requested. This provides essential context before the user interacts with the form. -->
    <!-- Visualization & Content Choices: The dynamic, scenario-based explanations on the right remain the same. A new static text block is added to the left panel for each tab. The content for this block is taken directly from the user's provided image and adapted for the other order types. This change improves the instructional design by separating foundational knowledge from interactive feedback. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        :root {
            --brand-navy: #203959;
            --brand-teal: #416772;
            --brand-teal-light: #96ada5;
            --text-light: #f1f5f9;
            --text-dark-accent: #a8b2c2;
            --bg-card: rgba(15, 23, 42, 0.5);
            --border-color: rgba(71, 85, 105, 0.8);
            --status-red: #ef4444;
            --status-green: #22c55e;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-image: linear-gradient(to bottom right, var(--brand-navy), var(--brand-teal));
            color: var(--text-light);
        }
        .header-title { color: #ffffff; text-shadow: 1px 1px 3px rgba(0,0,0,0.2); }
        .main-card {
            background-color: var(--bg-card);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
        }
        .tab-active {
            border-color: var(--brand-teal-light);
            color: var(--brand-teal-light);
            background-color: rgba(150, 173, 165, 0.1);
        }
        .order-type-btn {
            transition: all 0.2s ease-in-out;
            border: 1px solid var(--border-color);
            background-color: transparent;
        }
        .order-type-btn.buy.active { background-color: var(--status-green); border-color: var(--status-green); }
        .order-type-btn.sell.active { background-color: var(--status-red); border-color: var(--status-red); }
        .form-container.border-buy { border-left: 3px solid var(--status-green); }
        .form-container.border-sell { border-left: 3px solid var(--status-red); }
        
        .validation-icon {
            width: 20px; height: 20px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center;
            margin-left: 8px; transition: all 0.3s ease; opacity: 0; transform: scale(0.5);
        }
        .validation-icon.visible { opacity: 1; transform: scale(1); }
        .validation-icon.valid { background-color: var(--status-green); }
        .validation-icon.invalid { background-color: var(--status-red); }
        .validation-icon.valid::before { content: '✓'; color: white; font-weight: bold; font-size: 14px; }
        .validation-icon.invalid::before { content: '✗'; color: white; font-weight: bold; font-size: 14px; }
        
        .input-group { position: relative; display: flex; align-items: center; }
        .input-group .validation-icon { position: absolute; right: 10px; }
        .form-input, select { 
            background-color: rgba(0,0,0,0.2); 
            border-color: var(--border-color); 
            color: var(--text-light); 
        }
        .form-input:focus, select:focus {
            border-color: var(--brand-teal-light);
            box-shadow: 0 0 0 1px var(--brand-teal-light);
            outline: none;
        }
        
        .exp-panel { 
            background-color: rgba(0,0,0,0.1); 
            border: 1px solid var(--border-color);
        }
        .exp-header { color: var(--brand-teal-light); }
        .scenario-box h4 { color: var(--brand-teal-light); }
        .definition-box {
            background-color: rgba(0,0,0,0.15);
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 3px solid var(--brand-teal-light);
            margin-bottom: 1.5rem;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold header-title">Công cụ Mô phỏng Lệnh Điều kiện</h1>
            <p class="text-text-dark-accent mt-2">Thực hành và tìm hiểu cách hoạt động của các loại lệnh phổ biến.</p>
        </header>

        <div class="main-card p-6 rounded-2xl shadow-2xl">
            <nav class="flex border-b border-[var(--border-color)] mb-6">
                <button data-tab="stop-limit" class="py-3 px-4 md:px-6 font-semibold text-text-dark-accent border-b-2 border-transparent hover:text-[var(--brand-teal-light)] transition-colors duration-300 tab-active">Stop limit</button>
                <button data-tab="trailing-stop" class="py-3 px-4 md:px-6 font-semibold text-text-dark-accent border-b-2 border-transparent hover:text-[var(--brand-teal-light)] transition-colors duration-300">Trailing Stop</button>
                <button data-tab="oco" class="py-3 px-4 md:px-6 font-semibold text-text-dark-accent border-b-2 border-transparent hover:text-[var(--brand-teal-light)] transition-colors duration-300">OCO</button>
            </nav>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Left Column: Forms -->
                <div>
                    <!-- Stop Limit Form -->
                    <div id="stop-limit" class="tab-content">
                        <h3 class="text-xl font-bold exp-header mb-4">Nhập thông số Lệnh Stop limit</h3>
                        <div class="definition-box text-sm text-text-dark-accent">
                            <p><strong>Định nghĩa:</strong> Là lệnh đặt chờ có điều kiện. Lệnh chỉ được kích hoạt và đẩy vào sàn khi giá thị trường biến động đến một mức giá đã định sẵn (Giá kích hoạt).</p>
                            <p class="mt-2"><strong>Mục đích:</strong> Dùng để cắt lỗ (Stop-loss), chốt lời (Take-profit) hoặc mua/bán khi giá vượt qua một ngưỡng quan trọng (breakout/breakdown).</p>
                        </div>
                        <form id="form-stop-limit" class="form-container border-sell space-y-4 p-4 rounded-lg bg-transparent">
                             <div class="flex space-x-2">
                                <button type="button" class="order-type-btn sell active w-full py-2 rounded-md font-semibold text-white" data-form="stop-limit" data-type="sell">Bán</button>
                                <button type="button" class="order-type-btn buy w-full py-2 rounded-md font-semibold text-white" data-form="stop-limit" data-type="buy">Mua</button>
                            </div>
                            <div><label class="block text-sm font-medium text-text-dark-accent">Phương thức kích hoạt</label><select data-form="stop-limit" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm activation-method"><option value="last_price">Giá khớp cuối</option><option value="order_book">Top chờ khớp</option></select></div>
                            <div><label class="block text-sm font-medium text-text-dark-accent market-price-label" data-form="stop-limit">Giá tham chiếu (Giá khớp cuối)</label><input type="number" id="sl-market-price" value="80000" class="mt-1 form-input block w-full rounded-md shadow-sm sm:text-sm"></div>
                            <div class="input-group"><label class="block text-sm font-medium text-text-dark-accent w-full">Giá kích hoạt<input type="number" id="sl-stop-price" value="79000" class="form-input mt-1 block w-full rounded-md shadow-sm sm:text-sm"></label><span class="validation-icon" id="sl-stop-price-icon"></span></div>
                             <div class="input-group"><label class="block text-sm font-medium text-text-dark-accent w-full">Giá đặt<input type="number" id="sl-limit-price" value="78900" class="form-input mt-1 block w-full rounded-md shadow-sm sm:text-sm"></label><span class="validation-icon" id="sl-limit-price-icon"></span></div>
                        </form>
                    </div>

                    <!-- Trailing Stop Form -->
                    <div id="trailing-stop" class="tab-content hidden">
                        <h3 class="text-xl font-bold exp-header mb-4">Nhập thông số Lệnh Trailing Stop</h3>
                        <div class="definition-box text-sm text-text-dark-accent">
                           <p><strong>Định nghĩa:</strong> Là một lệnh cắt lỗ/chốt lời linh hoạt. Giá dừng (stop price) không cố định mà sẽ "trượt" theo giá thị trường khi giá đi theo hướng có lợi cho nhà đầu tư.</p>
                           <p class="mt-2"><strong>Mục đích:</strong> Tối đa hóa lợi nhuận khi giá cổ phiếu tăng (lệnh bán) hoặc mua được ở giá tốt hơn khi giá giảm (lệnh mua), trong khi vẫn bảo vệ khỏi sự đảo chiều đột ngột.</p>
                        </div>
                        <form id="form-trailing-stop" class="form-container border-sell space-y-4 p-4 rounded-lg bg-transparent">
                            <div class="flex space-x-2">
                                <button type="button" class="order-type-btn sell active w-full py-2 rounded-md font-semibold text-white" data-form="trailing-stop" data-type="sell">Bán</button>
                                <button type="button" class="order-type-btn buy w-full py-2 rounded-md font-semibold text-white" data-form="trailing-stop" data-type="buy">Mua</button>
                            </div>
                            <div><label class="block text-sm font-medium text-text-dark-accent">Phương thức kích hoạt</label><select data-form="trailing-stop" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm activation-method"><option value="last_price">Giá khớp cuối</option><option value="order_book">Top chờ khớp</option></select></div>
                            <div><label class="block text-sm font-medium text-text-dark-accent market-price-label" data-form="trailing-stop">Giá tham chiếu (Giá khớp cuối)</label><input type="number" id="ts-market-price" value="95000" class="mt-1 form-input block w-full rounded-md shadow-sm sm:text-sm"></div>
                            <div class="input-group"><label class="block text-sm font-medium text-text-dark-accent w-full">Biên độ trượt (VND)<input type="number" id="ts-offset-value" value="1000" class="form-input mt-1 block w-full rounded-md shadow-sm sm:text-sm"></label><span class="validation-icon" id="ts-offset-icon"></span></div>
                            <div class="input-group"><label class="block text-sm font-medium text-text-dark-accent w-full">Bước giá (VND)<input type="number" id="ts-step-price" value="100" class="form-input mt-1 block w-full rounded-md shadow-sm sm:text-sm"></label><span class="validation-icon" id="ts-step-price-icon"></span></div>
                        </form>
                    </div>

                    <!-- OCO Form -->
                    <div id="oco" class="tab-content hidden">
                        <h3 class="text-xl font-bold exp-header mb-4">Nhập thông số Lệnh OCO</h3>
                         <div class="definition-box text-sm text-text-dark-accent">
                           <p><strong>Định nghĩa:</strong> Là một cặp lệnh, thường gồm lệnh Giới hạn (chốt lời) và lệnh Dừng-Giới hạn (cắt lỗ). Khi một trong hai lệnh khớp hoặc được kích hoạt, lệnh còn lại sẽ tự động bị hủy.</p>
                           <p class="mt-2"><strong>Mục đích:</strong> Giúp tự động hóa việc chốt lời tại mức giá mục tiêu và đồng thời cắt lỗ tại một ngưỡng rủi ro đã xác định cho cùng một vị thế.</p>
                        </div>
                       <form id="form-oco" class="form-container border-sell space-y-4 p-4 rounded-lg bg-transparent">
                           <div class="flex space-x-2">
                                <button type="button" class="order-type-btn sell active w-full py-2 rounded-md font-semibold text-white" data-form="oco" data-type="sell">Bán</button>
                                <button type="button" class="order-type-btn buy w-full py-2 rounded-md font-semibold text-white" data-form="oco" data-type="buy">Mua</button>
                            </div>
                            <div><label class="block text-sm font-medium text-text-dark-accent">Phương thức kích hoạt</label><select data-form="oco" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm activation-method"><option value="last_price">Giá khớp cuối</option><option value="order_book">Top chờ khớp</option></select></div>
                            <div><label class="block text-sm font-medium text-text-dark-accent market-price-label" data-form="oco">Giá tham chiếu (Giá khớp cuối)</label><input type="number" id="oco-market-price" value="50000" class="mt-1 form-input block w-full rounded-md shadow-sm sm:text-sm"></div>
                            <div class="input-group"><label class="block text-sm font-medium text-text-dark-accent w-full">Giá chốt lời (Limit)<input type="number" id="oco-take-profit" value="52000" class="form-input mt-1 block w-full rounded-md shadow-sm sm:text-sm"></label><span class="validation-icon" id="oco-tp-icon"></span></div>
                            <div class="input-group"><label class="block text-sm font-medium text-text-dark-accent w-full">Giá cắt lỗ (Stop Price)<input type="number" id="oco-stop-loss" value="49000" class="form-input mt-1 block w-full rounded-md shadow-sm sm:text-sm"></label><span class="validation-icon" id="oco-sl-icon"></span></div>
                            <div class="input-group"><label class="block text-sm font-medium text-text-dark-accent w-full">Giá giới hạn cắt lỗ (Limit Price)<input type="number" id="oco-stop-limit" value="48900" class="form-input mt-1 block w-full rounded-md shadow-sm sm:text-sm"></label><span class="validation-icon" id="oco-sl-limit-icon"></span></div>
                        </form>
                    </div>
                </div>

                <!-- Right Column: Explanations -->
                <div class="exp-panel p-6 rounded-xl space-y-4">
                    <!-- Stop Limit Explanation -->
                    <div id="stop-limit-exp" class="exp-content">
                        <h3 class="text-xl font-bold exp-header mb-4">Diễn giải Chi tiết & Kịch bản</h3>
                        <div id="sl-dynamic-exp" class="text-sm space-y-4">
                            <p>Hãy nhập các thông số bên trái để xem diễn giải.</p>
                        </div>
                    </div>

                    <!-- Trailing Stop Explanation -->
                    <div id="trailing-stop-exp" class="exp-content hidden">
                         <h3 class="text-xl font-bold exp-header mb-4">Diễn giải Chi tiết & Kịch bản</h3>
                         <div id="ts-dynamic-exp" class="text-sm space-y-4">
                            <p>Hãy nhập các thông số bên trái để xem diễn giải.</p>
                        </div>
                    </div>

                    <!-- OCO Explanation -->
                    <div id="oco-exp" class="exp-content hidden">
                        <h3 class="text-xl font-bold exp-header mb-4">Diễn giải Chi tiết & Kịch bản</h3>
                         <div id="oco-dynamic-exp" class="text-sm space-y-4">
                             <p>Hãy nhập các thông số bên trái để xem diễn giải.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
         <footer class="text-center mt-8 text-sm text-text-dark-accent">
            <p>Công cụ này chỉ mang tính chất mô phỏng để hỗ trợ học tập. Không phải là khuyến nghị đầu tư.</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const tabs = document.querySelectorAll('nav button');
            const tabContents = document.querySelectorAll('.tab-content');
            const expContents = document.querySelectorAll('.exp-content');
            const orderTypeButtons = document.querySelectorAll('.order-type-btn');
            const activationMethods = document.querySelectorAll('.activation-method');

            const validationMap = {
                'stop-limit': validateStopLimit,
                'trailing-stop': validateTrailingStop,
                'oco': validateOCO
            };
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const target = tab.dataset.tab;
                    tabs.forEach(t => t.classList.remove('tab-active'));
                    tab.classList.add('tab-active');
                    tabContents.forEach(content => content.id === target ? content.classList.remove('hidden') : content.classList.add('hidden'));
                    expContents.forEach(exp => exp.id === `${target}-exp` ? exp.classList.remove('hidden') : exp.classList.add('hidden'));
                    if (validationMap[target]) validationMap[target]();
                });
            });

            orderTypeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const formId = button.dataset.form;
                    const orderType = button.dataset.type;
                    const form = document.getElementById(`form-${formId}`);
                    document.querySelectorAll(`.order-type-btn[data-form="${formId}"]`).forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    form.classList.toggle('border-buy', orderType === 'buy');
                    form.classList.toggle('border-sell', orderType === 'sell');
                    if (validationMap[formId]) validationMap[formId]();
                });
            });

            activationMethods.forEach(select => {
                select.addEventListener('change', (e) => {
                    const formId = e.target.dataset.form;
                    const label = document.querySelector(`.market-price-label[data-form="${formId}"]`);
                    const selectedText = e.target.options[e.target.selectedIndex].text;
                    label.textContent = `Giá tham chiếu (${selectedText})`;
                });
            });

            const f = (num) => new Intl.NumberFormat('vi-VN').format(num);
            const updateValidationIcon = (iconEl, isValid) => {
                iconEl.classList.add('visible');
                iconEl.classList.toggle('valid', isValid);
                iconEl.classList.toggle('invalid', !isValid);
            };
            const resetValidationIcon = (iconEl) => iconEl.classList.remove('visible', 'valid', 'invalid');
            const getActiveOrderType = (formId) => document.querySelector(`.order-type-btn[data-form="${formId}"].active`).dataset.type;

            function validateStopLimit() {
                const orderType = getActiveOrderType('stop-limit');
                const marketPrice = parseFloat(document.getElementById('sl-market-price').value);
                const stopPrice = parseFloat(document.getElementById('sl-stop-price').value);
                const limitPrice = parseFloat(document.getElementById('sl-limit-price').value);
                const stopPriceIcon = document.getElementById('sl-stop-price-icon');
                const limitPriceIcon = document.getElementById('sl-limit-price-icon');
                const expDiv = document.getElementById('sl-dynamic-exp');

                let errors = [];
                let isStopValid = false;
                let isLimitValid = false;

                if (isNaN(stopPrice)) resetValidationIcon(stopPriceIcon);
                if (isNaN(limitPrice)) resetValidationIcon(limitPriceIcon);
                
                if (isNaN(marketPrice) || isNaN(stopPrice) || isNaN(limitPrice)) {
                    expDiv.innerHTML = `<p>Hãy nhập đầy đủ các thông số để xem diễn giải.</p>`;
                    return;
                }

                if (orderType === 'sell') {
                    isStopValid = stopPrice <= marketPrice;
                    if (!isStopValid) errors.push(`<strong>Lỗi:</strong> Giá kích hoạt phải ≤ giá tham chiếu (${f(marketPrice)}).`);
                    updateValidationIcon(stopPriceIcon, isStopValid);
                    isLimitValid = limitPrice <= stopPrice;
                    if (!isLimitValid) errors.push(`<strong>Lỗi:</strong> Giá đặt nên ≤ giá kích hoạt để tăng khả năng khớp lệnh.`);
                    updateValidationIcon(limitPriceIcon, isLimitValid);
                } else { // buy
                    isStopValid = stopPrice >= marketPrice;
                    if (!isStopValid) errors.push(`<strong>Lỗi:</strong> Giá kích hoạt phải ≥ giá tham chiếu (${f(marketPrice)}).`);
                    updateValidationIcon(stopPriceIcon, isStopValid);
                    isLimitValid = limitPrice >= stopPrice;
                    if (!isLimitValid) errors.push(`<strong>Lỗi:</strong> Giá đặt nên ≥ giá kích hoạt để tăng khả năng khớp lệnh.`);
                    updateValidationIcon(limitPriceIcon, isLimitValid);
                }
                
                let html = [];
                if (errors.length > 0) {
                     html.push(`<div class="p-4 rounded-md bg-red-900/50 border border-red-700">${errors.join('<br>')}</div>`);
                } else {
                    const action = orderType === 'sell' ? 'BÁN' : 'MUA';
                    const condition = orderType === 'sell' ? 'giảm xuống ≤' : 'tăng lên ≥';
                    html.push(`<div class="scenario-box">
                        <h4 class="font-bold text-lg mb-2">Diễn giải lệnh</h4>
                        <p>Lệnh sẽ được theo dõi. Nếu giá thị trường ${condition} <strong>${f(stopPrice)}</strong>, một lệnh ${action} GIỚI HẠN (LO) sẽ được gửi vào sàn với giá đặt là <strong>${f(limitPrice)}</strong>.</p>
                    </div>`);
                    html.push(`<div class="scenario-box mt-4">
                        <h4 class="font-bold text-lg mb-2">Kịch bản</h4>
                        <ul class="list-disc list-inside space-y-2 text-text-dark-accent">
                            ${orderType === 'sell' ? 
                            `<li><strong>Giá tăng/đi ngang:</strong> Lệnh tiếp tục ở trạng thái chờ, không có gì xảy ra.</li>
                            <li><strong>Giá giảm và kích hoạt:</strong> Khi giá thị trường chạm <strong>${f(stopPrice)}</strong>, lệnh BÁN LO tại giá <strong>${f(limitPrice)}</strong> được đẩy vào sàn. Lệnh sẽ khớp tại giá ${f(limitPrice)} hoặc tốt hơn (cao hơn).</li>` : 
                            `<li><strong>Giá giảm/đi ngang:</strong> Lệnh tiếp tục ở trạng thái chờ, không có gì xảy ra.</li>
                            <li><strong>Giá tăng và kích hoạt:</strong> Khi giá thị trường chạm <strong>${f(stopPrice)}</strong>, lệnh MUA LO tại giá <strong>${f(limitPrice)}</strong> được đẩy vào sàn. Lệnh sẽ khớp tại giá ${f(limitPrice)} hoặc tốt hơn (thấp hơn).</li>`}
                        </ul>
                    </div>`);
                }
                expDiv.innerHTML = html.join('');
            }

            function validateTrailingStop() {
                const orderType = getActiveOrderType('trailing-stop');
                const marketPrice = parseFloat(document.getElementById('ts-market-price').value);
                const offsetValue = parseFloat(document.getElementById('ts-offset-value').value);
                const stepPrice = parseFloat(document.getElementById('ts-step-price').value);
                const offsetIcon = document.getElementById('ts-offset-icon');
                const stepPriceIcon = document.getElementById('ts-step-price-icon');
                const expDiv = document.getElementById('ts-dynamic-exp');

                let isOffsetValid = !isNaN(offsetValue) && offsetValue > 0;
                let isStepValid = !isNaN(stepPrice) && stepPrice >= 0;
                if (!isNaN(offsetValue)) updateValidationIcon(offsetIcon, isOffsetValid); else resetValidationIcon(offsetIcon);
                if (!isNaN(stepPrice)) updateValidationIcon(stepPriceIcon, isStepValid); else resetValidationIcon(stepPriceIcon);

                if (!isOffsetValid || !isStepValid || isNaN(marketPrice)) {
                    expDiv.innerHTML = `<p>Hãy nhập đầy đủ các thông số để xem diễn giải.</p>`;
                    return;
                }
                
                let initialStopPrice, orderPriceOnTrigger, html = [];
                if (orderType === 'sell') {
                    initialStopPrice = marketPrice - offsetValue;
                    orderPriceOnTrigger = initialStopPrice - stepPrice;
                    html.push(`<div class="scenario-box">
                        <h4 class="font-bold text-lg mb-2">Diễn giải lệnh</h4>
                        <p class="mb-2">Giá dừng ban đầu được đặt ở <strong>${f(initialStopPrice)}</strong> (thấp hơn giá thị trường ${f(offsetValue)}).</p>
                        <p>Khi kích hoạt, một lệnh BÁN sẽ được đặt với giá <strong>${f(orderPriceOnTrigger)}</strong> (Giá dừng - Bước giá).</p>
                    </div>`);
                    html.push(`<div class="scenario-box mt-4">
                        <h4 class="font-bold text-lg mb-2">Kịch bản</h4>
                        <ul class="list-disc list-inside space-y-2 text-text-dark-accent">
                            <li><strong>Giá tăng:</strong> Giá dừng sẽ trượt lên theo, luôn duy trì khoảng cách ${f(offsetValue)} so với đỉnh giá mới. Ví dụ giá tăng lên ${f(marketPrice + 2000)}, giá dừng mới sẽ là ${f(initialStopPrice + 2000)}.</li>
                             <li><strong>Giá giảm:</strong> Giá dừng giữ nguyên. Lệnh sẽ được kích hoạt nếu giá giảm chạm mức dừng hiện tại.</li>
                        </ul>
                    </div>`);
                } else { 
                    initialStopPrice = marketPrice + offsetValue;
                    orderPriceOnTrigger = initialStopPrice + stepPrice;
                    html.push(`<div class="scenario-box">
                        <h4 class="font-bold text-lg mb-2">Diễn giải lệnh</h4>
                        <p class="mb-2">Giá dừng ban đầu được đặt ở <strong>${f(initialStopPrice)}</strong> (cao hơn giá thị trường ${f(offsetValue)}).</p>
                        <p>Khi kích hoạt, một lệnh MUA sẽ được đặt với giá <strong>${f(orderPriceOnTrigger)}</strong> (Giá dừng + Bước giá).</p>
                    </div>`);
                     html.push(`<div class="scenario-box mt-4">
                        <h4 class="font-bold text-lg mb-2">Kịch bản</h4>
                        <ul class="list-disc list-inside space-y-2 text-text-dark-accent">
                            <li><strong>Giá giảm:</strong> Giá dừng sẽ trượt xuống theo, luôn duy trì khoảng cách ${f(offsetValue)} so với đáy giá mới. Ví dụ giá giảm xuống ${f(marketPrice - 2000)}, giá dừng mới sẽ là ${f(initialStopPrice - 2000)}.</li>
                            <li><strong>Giá tăng:</strong> Giá dừng giữ nguyên. Lệnh sẽ được kích hoạt nếu giá tăng chạm mức dừng hiện tại.</li>
                        </ul>
                    </div>`);
                }
                expDiv.innerHTML = html.join('');
            }

            function validateOCO() {
                const orderType = getActiveOrderType('oco');
                const marketPrice = parseFloat(document.getElementById('oco-market-price').value);
                const takeProfit = parseFloat(document.getElementById('oco-take-profit').value);
                const stopLoss = parseFloat(document.getElementById('oco-stop-loss').value);
                const stopLimit = parseFloat(document.getElementById('oco-stop-limit').value);
                const tpIcon = document.getElementById('oco-tp-icon');
                const slIcon = document.getElementById('oco-sl-icon');
                const slLimitIcon = document.getElementById('oco-sl-limit-icon');
                const expDiv = document.getElementById('oco-dynamic-exp');

                if(isNaN(takeProfit)) resetValidationIcon(tpIcon);
                if(isNaN(stopLoss)) resetValidationIcon(slIcon);
                if(isNaN(stopLimit)) resetValidationIcon(slLimitIcon);
                
                if (isNaN(marketPrice) || isNaN(takeProfit) || isNaN(stopLoss) || isNaN(stopLimit)) {
                     expDiv.innerHTML = `<p>Hãy nhập đầy đủ các thông số để xem diễn giải.</p>`;
                    return;
                }

                let errors = [], isTpValid = false, isSlValid = false, isSlLimitValid = false;

                if (orderType === 'sell') {
                    isTpValid = takeProfit > marketPrice;
                    if (!isTpValid) errors.push(`<strong>Lỗi TP:</strong> Giá chốt lời phải > giá tham chiếu.`);
                    updateValidationIcon(tpIcon, isTpValid);
                    isSlValid = stopLoss < marketPrice;
                    if (!isSlValid) errors.push(`<strong>Lỗi SL:</strong> Giá cắt lỗ phải < giá tham chiếu.`);
                    updateValidationIcon(slIcon, isSlValid);
                    isSlLimitValid = stopLimit <= stopLoss;
                    if (!isSlLimitValid) errors.push(`<strong>Lỗi SL Limit:</strong> Giá đặt SL nên ≤ giá kích hoạt SL.`);
                    updateValidationIcon(slLimitIcon, isSlLimitValid);
                } else {
                    isTpValid = takeProfit < marketPrice;
                    if(!isTpValid) errors.push(`<strong>Lỗi TP:</strong> Giá chốt lời phải < giá tham chiếu.`);
                    updateValidationIcon(tpIcon, isTpValid);
                    isSlValid = stopLoss > marketPrice;
                    if(!isSlValid) errors.push(`<strong>Lỗi SL:</strong> Giá cắt lỗ phải > giá tham chiếu.`);
                    updateValidationIcon(slIcon, isSlValid);
                    isSlLimitValid = stopLimit >= stopLoss;
                    if(!isSlLimitValid) errors.push(`<strong>Lỗi SL Limit:</strong> Giá đặt SL nên ≥ giá kích hoạt SL.`);
                    updateValidationIcon(slLimitIcon, isSlLimitValid);
                }
                
                let html = [];
                if (errors.length > 0) {
                     html.push(`<div class="p-4 rounded-md bg-red-900/50 border border-red-700">${errors.join('<br>')}</div>`);
                } else {
                     html.push(`<div class="scenario-box">
                        <h4 class="font-bold text-lg mb-2">Diễn giải lệnh</h4>
                        <p>Đây là một cặp lệnh: một lệnh chốt lời và một lệnh cắt lỗ. Khi một trong hai được kích hoạt, lệnh còn lại sẽ tự động bị hủy.</p>
                    </div>`);
                     html.push(`<div class="scenario-box mt-4">
                        <h4 class="font-bold text-lg mb-2">Kịch bản</h4>
                        <ul class="list-disc list-inside space-y-2 text-text-dark-accent">
                             ${orderType === 'sell' ? 
                            `<li><strong>Giá tăng đến ${f(takeProfit)}:</strong> Lệnh chốt lời được khớp. Lệnh cắt lỗ tại ${f(stopLoss)} sẽ bị hủy.</li>
                             <li><strong>Giá giảm đến ${f(stopLoss)}:</strong> Lệnh cắt lỗ được kích hoạt, đặt lệnh bán LO tại ${f(stopLimit)}. Lệnh chốt lời tại ${f(takeProfit)} sẽ bị hủy.</li>` :
                            `<li><strong>Giá giảm đến ${f(takeProfit)}:</strong> Lệnh chốt lời (mua) được khớp. Lệnh cắt lỗ tại ${f(stopLoss)} sẽ bị hủy.</li>
                             <li><strong>Giá tăng đến ${f(stopLoss)}:</strong> Lệnh cắt lỗ được kích hoạt, đặt lệnh mua LO tại ${f(stopLimit)}. Lệnh chốt lời tại ${f(takeProfit)} sẽ bị hủy.</li>`}
                             <li><strong>Giá đi ngang:</strong> Cả hai lệnh vẫn ở trạng thái chờ.</li>
                        </ul>
                    </div>`);
                }
                expDiv.innerHTML = html.join('');
            }
            
            document.querySelectorAll('form input, form select').forEach(el => el.addEventListener('input', () => {
                const formId = el.closest('form').id.replace('form-', '');
                if(validationMap[formId]) validationMap[formId]();
            }));

            document.querySelector('nav button[data-tab="stop-limit"]').click();
        });
    </script>
</body>
</html>
